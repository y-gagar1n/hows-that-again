<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/hows-that-again/component---src-layouts-index-js-1480ae19d67cb2342bca.js" as="script"/><link rel="preload" href="/hows-that-again/component---src-templates-blog-template-js-40956da8f886eafeb36f.js" as="script"/><link rel="preload" href="/hows-that-again/path---blog-gstreamer-17e17ee2f5b769d89761.js" as="script"/><link rel="preload" href="/hows-that-again/app-760779f5366ac4d94583.js" as="script"/><link rel="preload" href="/hows-that-again/commons-afb5782224ac01f1fa03.js" as="script"/><title data-react-helmet="true">How&#x27;s that again?</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><style id="gatsby-inlined-css">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt","kern"}img{max-width:100%;margin:0 0 1.45rem;padding:0}h1{font-size:2.25rem}h1,h2{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{margin:0 0 1.45rem 1.45rem;padding:0;list-style-position:outside;list-style-image:none}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{padding:0;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}pre,table{margin:0 0 1.45rem}table{padding:0;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{margin:0 0 calc(1.45rem - 1px);padding:0;background:rgba(0,0,0,.2);border:none;height:1px}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:0;padding-top:.2em;padding-bottom:.2em}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="-130159683"><!-- react-empty: 2 --><div style="background:rebeccapurple;margin-bottom:1.45rem;" data-reactid="3"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;" data-reactid="4"><h1 style="margin:0;" data-reactid="5"><a style="color:white;text-decoration:none;" href="/hows-that-again/" data-reactid="6">How&#x27;s that again?</a></h1></div></div><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0;" data-reactid="7"><div class="blog-post-container" data-reactid="8"><div class="blog-post" data-reactid="9"><div class="blog-post-content" data-reactid="10"><h1>Gstreamer</h1>
<p><a href="https://habr.com/ru/post/251427/">https://habr.com/ru/post/251427/</a></p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">#include <span class="token operator">&lt;</span>gst<span class="token operator">/</span>gst<span class="token punctuation">.</span>h<span class="token operator">></span>
int main <span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		g_print <span class="token punctuation">(</span><span class="token string">"Syntax error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	GstElement <span class="token operator">*</span>pipeline<span class="token punctuation">,</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token operator">*</span>dst<span class="token punctuation">;</span>
	<span class="token comment">/* Сюда будет читаться результат попытки запуска потока. */</span>
	GstStateChangeReturn ret<span class="token punctuation">;</span>
	<span class="token comment">/* bus - это шина конвейера. Через нее мы можем получать сообщения о событиях. */</span>
	GstBus <span class="token operator">*</span>bus<span class="token punctuation">;</span>
	GstMessage <span class="token operator">*</span>msg<span class="token punctuation">;</span>

	<span class="token comment">/* Инициализация GStreamer */</span>
	gst_init <span class="token punctuation">(</span>NULL<span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Создаем элементы */</span>
	pipeline <span class="token operator">=</span> gst_element_factory_make <span class="token punctuation">(</span><span class="token string">"pipeline"</span><span class="token punctuation">,</span> <span class="token string">"pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	src <span class="token operator">=</span> gst_element_factory_make <span class="token punctuation">(</span><span class="token string">"filesrc"</span><span class="token punctuation">,</span> <span class="token string">"src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	dst <span class="token operator">=</span> gst_element_factory_make <span class="token punctuation">(</span><span class="token string">"filesink"</span><span class="token punctuation">,</span> <span class="token string">"dst"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>pipeline <span class="token operator">||</span> <span class="token operator">!</span>src <span class="token operator">||</span> <span class="token operator">!</span>dst <span class="token punctuation">)</span> <span class="token punctuation">{</span>
		g_printerr <span class="token punctuation">(</span><span class="token string">"Unable to create some elements\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* Добавляем элементы в конвейер */</span>
	gst_bin_add_many <span class="token punctuation">(</span><span class="token function">GST_BIN</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* И связываем их */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> gst_element_link <span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span> <span class="token operator">!=</span> TRUE <span class="token punctuation">)</span> 	<span class="token punctuation">{</span>
		g_printerr <span class="token punctuation">(</span><span class="token string">"Elements can not be linked\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		gst_object_unref <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* Задаем элементам свойства */</span>
	g_object_set <span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">"location"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	g_object_set <span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">"location"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Запускаем конвейер */</span>
	ret <span class="token operator">=</span> gst_element_set_state <span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> GST_STATE_PLAYING<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">==</span> GST_STATE_CHANGE_FAILURE <span class="token punctuation">)</span> <span class="token punctuation">{</span>
		g_printerr <span class="token punctuation">(</span><span class="token string">"Unable to set pipeline to the playing state\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		gst_object_unref <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* Мало просто установить режим PLAYING. Нужно ждать либо конца потока, либо 
	 * ошибок. Для начала подключаемся к шине конвейера (эти манипуляции будут 
	 * описаны в следующей статье) */</span>
	bus <span class="token operator">=</span> gst_element_get_bus <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* И ожидаем события на шине. Когда событие произойдет, функция вернет 
	 * сообщение, которое мы будем парсить. */</span>
	msg <span class="token operator">=</span> gst_bus_timed_pop_filtered <span class="token punctuation">(</span>bus<span class="token punctuation">,</span> GST_CLOCK_TIME_NONE<span class="token punctuation">,</span> GST_MESSAGE_ERROR <span class="token operator">|</span> GST_MESSAGE_EOS<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Парсим сообщение */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> NULL<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		GError <span class="token operator">*</span>err<span class="token punctuation">;</span>
		gchar <span class="token operator">*</span>debug_info<span class="token punctuation">;</span>

		switch <span class="token punctuation">(</span> GST_MESSAGE_TYPE <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			case GST_MESSAGE_ERROR<span class="token punctuation">:</span>
				gst_message_parse_error <span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">,</span> <span class="token operator">&amp;</span>debug_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
				g_printerr <span class="token punctuation">(</span><span class="token string">"Error received from element %s: %s\n"</span><span class="token punctuation">,</span> GST_OBJECT_NAME <span class="token punctuation">(</span>msg<span class="token operator">-</span><span class="token operator">></span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token operator">-</span><span class="token operator">></span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
				g_printerr <span class="token punctuation">(</span><span class="token string">"Debugging information: %s\n"</span><span class="token punctuation">,</span> debug_info <span class="token operator">?</span> debug_info <span class="token punctuation">:</span> <span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				g_clear_error <span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				g_free <span class="token punctuation">(</span>debug_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			case GST_MESSAGE_EOS<span class="token punctuation">:</span>
				g_print <span class="token punctuation">(</span><span class="token string">"We reach End-Of-Stream\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>

			default<span class="token punctuation">:</span>
				g_printerr <span class="token punctuation">(</span><span class="token string">"Unexpected message received\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		gst_message_unref <span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* Освобождаем ресурсы */</span>
	gst_object_unref <span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
	gst_element_set_state <span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> GST_STATE_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	gst_object_unref <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Типичное создание пайплайна</h2>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">pipeline <span class="token operator">=</span> gst_pipeline_new <span class="token punctuation">(</span><span class="token string">"my-pipeline"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

bus <span class="token operator">=</span> gst_pipeline_get_bus <span class="token punctuation">(</span>GST_PIPELINE <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_bus_add_signal_watch <span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
g_signal_connect <span class="token punctuation">(</span>bus<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>GCallback<span class="token punctuation">)</span> cb_message<span class="token punctuation">,</span>
  pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>

src <span class="token operator">=</span> gst_element_factory_make <span class="token punctuation">(</span><span class="token string">"uridecodebin"</span><span class="token punctuation">,</span> <span class="token string">"src"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>src <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
g_error <span class="token punctuation">(</span><span class="token string">"Could not create 'uridecodebin' element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

g_object_set <span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">"uri"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

csp <span class="token operator">=</span> gst_element_factory_make <span class="token punctuation">(</span><span class="token string">"videoconvert"</span><span class="token punctuation">,</span> <span class="token string">"csp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>csp <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
g_error <span class="token punctuation">(</span><span class="token string">"Could not create 'videoconvert' element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vs <span class="token operator">=</span> gst_element_factory_make <span class="token punctuation">(</span><span class="token string">"videoscale"</span><span class="token punctuation">,</span> <span class="token string">"vs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>csp <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
g_error <span class="token punctuation">(</span><span class="token string">"Could not create 'videoscale' element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sink <span class="token operator">=</span> gst_element_factory_make <span class="token punctuation">(</span><span class="token string">"autovideosink"</span><span class="token punctuation">,</span> <span class="token string">"sink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sink <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
g_error <span class="token punctuation">(</span><span class="token string">"Could not create 'autovideosink' element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gst_bin_add_many <span class="token punctuation">(</span>GST_BIN <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> csp<span class="token punctuation">,</span> vs<span class="token punctuation">,</span> sink<span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>API</h2>
<p><code class="language-text">gst_buffer_map</code> позволяет доставать <code class="language-text">GstMapInfo</code> из <code class="language-text">GstBuffer</code></p>
<p>У GstMapInfo есть поля:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">guint8 <span class="token operator">*</span>data<span class="token punctuation">;</span>
gsize size<span class="token punctuation">;</span></code></pre></div>
<p>Pad probes are best suited for looking at data as it passes through the pipeline. If you need to modify data, you should rather write your own GStreamer element. Base classes like GstAudioFilter, GstVideoFilter or GstBaseTransform make this fairly easy.</p>
<p>If you just want to inspect buffers as they pass through the pipeline, you don't even need to set up pad probes. You could also just insert an identity element into the pipeline and connect to its "handoff" signal. The identity element also provides a few useful debugging tools like the dump and last-message properties; the latter is enabled by passing the '-v' switch to gst-launch and setting the silent property on the identity to FALSE.</p>
<h2>tcp</h2>
<h3>multifdsink</h3>
<p><a href="https://gstreamer.freedesktop.org/documentation/tcp/multifdsink.html?gi-language=c#multifdsink">https://gstreamer.freedesktop.org/documentation/tcp/multifdsink.html?gi-language=c#multifdsink</a></p>
<p>Может писать поток в указанные файловые дескрипторы. Дескрипторы добавляются и удаляются через сигналы (<code class="language-text">add</code>, <code class="language-text">remove</code>)</p>
<h3>tcpclientsink/tcpserversrc</h3>
<p>Сами создают сокеты, достаточно передать лишь номер порта</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">gst-launch-1.0 tcpserversrc <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">9999</span> <span class="token operator">!</span> decodebin <span class="token operator">!</span> alsasink
gst-launch-1.0 filesrc <span class="token assign-left variable">location</span><span class="token operator">=</span>/home/yury-timofeev/samples/1.mp3 <span class="token operator">!</span> tcpclientsink <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">9999</span></code></pre></div>
<p>Можно и микшировать сразу:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">gst<span class="token operator">-</span>launch<span class="token operator">-</span><span class="token number">1.0</span> tcpserversrc port<span class="token operator">=</span><span class="token number">9999</span> <span class="token operator">!</span> decodebin <span class="token operator">!</span> audiomixer name<span class="token operator">=</span>mix <span class="token operator">!</span> alsasink tcpserversrc port<span class="token operator">=</span><span class="token number">9998</span> <span class="token operator">!</span> decodebin <span class="token operator">!</span> mix<span class="token punctuation">.</span>
gst<span class="token operator">-</span>launch<span class="token operator">-</span><span class="token number">1.0</span> filesrc location<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>yury<span class="token operator">-</span>timofeev<span class="token operator">/</span>samples<span class="token operator">/</span><span class="token number">1.</span>mp3 <span class="token operator">!</span> tcpclientsink port<span class="token operator">=</span><span class="token number">9999</span>
gst<span class="token operator">-</span>launch<span class="token operator">-</span><span class="token number">1.0</span> filesrc location<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>yury<span class="token operator">-</span>timofeev<span class="token operator">/</span>samples<span class="token operator">/</span><span class="token number">2.</span>mp3 <span class="token operator">!</span> tcpclientsink port<span class="token operator">=</span><span class="token number">9998</span></code></pre></div>
<p>При этом если мы хотим использовать <code class="language-text">decodebin</code> на отправляющей стороне, то нужно поизвращаться:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">gst<span class="token operator">-</span>launch<span class="token operator">-</span><span class="token number">1.0</span> tcpserversrc port<span class="token operator">=</span><span class="token number">9999</span> <span class="token operator">!</span> audio<span class="token operator">/</span>x<span class="token operator">-</span>raw<span class="token punctuation">,</span>format<span class="token operator">=</span>S8<span class="token punctuation">,</span>channels<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>rate<span class="token operator">=</span><span class="token number">48000</span> <span class="token operator">!</span> audioconvert <span class="token operator">!</span> alsasink

gst<span class="token operator">-</span>launch<span class="token operator">-</span><span class="token number">1.0</span> filesrc location<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>yury<span class="token operator">-</span>timofeev<span class="token operator">/</span>samples<span class="token operator">/</span><span class="token number">1.</span>mp3 <span class="token operator">!</span> decodebin <span class="token operator">!</span> audioconvert <span class="token operator">!</span> audioresample <span class="token operator">!</span> audio<span class="token operator">/</span>x<span class="token operator">-</span>raw<span class="token punctuation">,</span>format<span class="token operator">=</span>S8<span class="token punctuation">,</span>channels<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>rate<span class="token operator">=</span><span class="token number">48000</span> <span class="token operator">!</span> tcpclientsink port<span class="token operator">=</span><span class="token number">9999</span></code></pre></div>
<h2>Сигналы</h2>
<p>Используется концепция сигналов из GObjects (не имеют ничего общего с UNIX-сигналами): <a href="https://developer.gnome.org/gobject/stable/signal.html">https://developer.gnome.org/gobject/stable/signal.html</a></p>
<p>Вот так мы посылаем сигнал в элемент:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">GstElement <span class="token operator">*</span>sink <span class="token operator">=</span> <span class="token function">gst_bin_get_by_name</span><span class="token punctuation">(</span><span class="token function">GST_BIN</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g_signal_emit_by_name</span><span class="token punctuation">(</span>sink<span class="token punctuation">,</span> <span class="token string">"add"</span><span class="token punctuation">,</span> <span class="token string">"192.168.1.25"</span><span class="token punctuation">,</span> <span class="token number">5004</span><span class="token punctuation">,</span> NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g_object_unref</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>decodebin, oggdemux</h2>
<p><a href="https://gstreamer.freedesktop.org/documentation/application-development/basics/pads.html#dynamic-or-sometimes-pads">https://gstreamer.freedesktop.org/documentation/application-development/basics/pads.html#dynamic-or-sometimes-pads</a></p>
<p>Декодирующие элементы <code class="language-text">decodebin</code> и <code class="language-text">oggdemux</code> имеют особую природу. Так как <code class="language-text">decodebin</code> может работать со многими форматами, а <code class="language-text">oggdemux</code> может работать с аудио- и видео-потоком, то их синки становятся известны лишь во время выполнения. Поэтому они не могут быть связаны обычным образом и их нужно добавлять динамически. Делается это так:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">#include <span class="token operator">&lt;</span>gobject<span class="token operator">/</span>gsignal<span class="token punctuation">.</span>h<span class="token operator">></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
GstElement <span class="token operator">*</span>pipeline <span class="token operator">=</span> <span class="token function">gst_pipeline_new</span><span class="token punctuation">(</span><span class="token string">"audio-sender"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GstElement <span class="token operator">*</span>source <span class="token operator">=</span> <span class="token function">gst_element_factory_make</span><span class="token punctuation">(</span><span class="token string">"filesrc"</span><span class="token punctuation">,</span> <span class="token string">"file-source"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GstElement <span class="token operator">*</span>decodebin <span class="token operator">=</span> <span class="token function">gst_element_factory_make</span><span class="token punctuation">(</span><span class="token string">"decodebin"</span><span class="token punctuation">,</span> <span class="token string">"decodebin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GstElement <span class="token operator">*</span>alsasink <span class="token operator">=</span> <span class="token function">gst_element_factory_make</span><span class="token punctuation">(</span><span class="token string">"alsasink"</span><span class="token punctuation">,</span> <span class="token string">"alsasink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

GstBus<span class="token operator">*</span> bus <span class="token operator">=</span> <span class="token function">gst_pipeline_get_bus</span><span class="token punctuation">(</span><span class="token function">GST_PIPELINE</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
guint bus_watch_id <span class="token operator">=</span> <span class="token function">gst_bus_add_watch</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> bus_call<span class="token punctuation">,</span> loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">gst_object_unref</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">gst_bin_add_many</span><span class="token punctuation">(</span><span class="token function">GST_BIN</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> decodebin<span class="token punctuation">,</span> alsasink<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// в бин добавляем все 3 элемента</span>
<span class="token function">gst_element_link</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> decodebin<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// связываем только первые 2 элемента: filesrc ! decodebin</span>

<span class="token function">g_signal_connect</span><span class="token punctuation">(</span>decodebin<span class="token punctuation">,</span> <span class="token string">"pad-added"</span><span class="token punctuation">,</span> <span class="token function">G_CALLBACK</span><span class="token punctuation">(</span>on_pad_added<span class="token punctuation">)</span><span class="token punctuation">,</span> alsasink<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// на decodebin привязываемся к сигналу pad-added, который будет вызван, когда у decodebin появился pad, который sink (в начале работы такого пада у него нет)</span></code></pre></div>
<p>Коллбэк выглядит так:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">static void on_pad_added <span class="token punctuation">(</span>GstElement <span class="token operator">*</span>element<span class="token punctuation">,</span>
              GstPad     <span class="token operator">*</span>pad<span class="token punctuation">,</span>
              gpointer    data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    GstPad <span class="token operator">*</span>sinkpad<span class="token punctuation">;</span>
    GstElement <span class="token operator">*</span>alsasink <span class="token operator">=</span> <span class="token punctuation">(</span>GstElement <span class="token operator">*</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>

    sinkpad <span class="token operator">=</span> gst_element_get_static_pad <span class="token punctuation">(</span>alsasink<span class="token punctuation">,</span> <span class="token string">"sink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// берем пад, равный синку (то есть входной) у элемента alsasink</span>

    gst_pad_link <span class="token punctuation">(</span>pad<span class="token punctuation">,</span> sinkpad<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// связываем наш пад (т.е. decodebin) с синком алсасинка</span>

    gst_object_unref <span class="token punctuation">(</span>sinkpad<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>capsfilter</h2>
<p>Когда вместо элемента в пайплайне начинает идти формат: </p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">gst<span class="token operator">-</span>launch<span class="token operator">-</span><span class="token number">1.0</span> tcpserversrc port<span class="token operator">=</span><span class="token number">9999</span> <span class="token operator">!</span> audio<span class="token operator">/</span>x<span class="token operator">-</span>raw<span class="token punctuation">,</span>format<span class="token operator">=</span>S8<span class="token punctuation">,</span>channels<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>rate<span class="token operator">=</span><span class="token number">48000</span> <span class="token operator">!</span> audioconvert <span class="token operator">!</span> alsasink</code></pre></div>
<p>то это алиас для:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">gst<span class="token operator">-</span>launch<span class="token operator">-</span><span class="token number">1.0</span> tcpserversrc port<span class="token operator">=</span><span class="token number">9999</span> <span class="token operator">!</span> capsfilter caps<span class="token operator">=</span>audio<span class="token operator">/</span>x<span class="token operator">-</span>raw<span class="token punctuation">,</span>format<span class="token operator">=</span>S8<span class="token punctuation">,</span>channels<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>rate<span class="token operator">=</span><span class="token number">48000</span> <span class="token operator">!</span> audioconvert <span class="token operator">!</span> alsasink</code></pre></div>
<p>Я так до конца и не понял, что делает <code class="language-text">capsfilter</code>, но вроде как он устанавливает ограничения для связи между двумя элементами. </p>
<h2>Итерирование по элементам бина</h2>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike"><span class="token function">g_print</span><span class="token punctuation">(</span><span class="token string">"Pipeline contains the following elements:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GstIterator <span class="token operator">*</span>it<span class="token punctuation">;</span>
GValue elem <span class="token operator">=</span> G_VALUE_INIT<span class="token punctuation">;</span>
it <span class="token operator">=</span> <span class="token function">gst_bin_iterate_elements</span><span class="token punctuation">(</span><span class="token function">GST_BIN</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">gst_iterator_next</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token operator">&amp;</span>elem<span class="token punctuation">)</span> <span class="token operator">==</span> GST_ITERATOR_OK<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">g_print</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span>
        <span class="token function">gst_element_get_name</span><span class="token punctuation">(</span><span class="token function">g_value_get_object</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">g_value_reset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">g_value_unset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">gst_iterator_free</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2>queue2</h2>
<ul>
<li>
<p><code class="language-text">buffering_level</code> - текущий уровень заполненности очереди. Нормализованный, принимает значения от 0 до 1.000.000</p>
</li>
<li>
<p><code class="language-text">buffering_percent</code> - уровень заполненности промежутка между high и low вотермарками. 0% означает, что <code class="language-text">buffering_level == low_watermark</code>, 100% означает, что <code class="language-text">buffering_level == high_watermark</code>. Принимает значения от 0 до 100.</p>
</li>
<li>
<p><code class="language-text">BUF_LEVEL_PERCENT_FACTOR</code> - чему в абсолютных значениях равен 1% buffering level, то есть <code class="language-text">BUF_LEVEL_PERCENT_FACTOR ((MAX_BUFFERING_LEVEL) / 100) = 10.000</code></p>
</li>
</ul>
<p><code class="language-text">gst_queue2_chain</code> - сюда поступают, здесь процессятся и отсюда выходят данные пайплайна. Это основная функция.</p>
<p>Она форвардит вызов к <code class="language-text">gst_queue2_chain_buffer_or_buffer_list</code>. Там поступивший буфер кладется во внутреннюю очередь строчкой <code class="language-text">gst_queue2_locked_enqueue</code></p>
<p>Следующие строки в методе <code class="language-text">get_buffering_level</code>, кажется, наконец выставляют <code class="language-text">buffering_level</code>:</p>
<div class="gatsby-highlight" data-language="clike"><pre class="language-clike"><code class="language-clike">#define <span class="token function">GET_BUFFER_LEVEL_FOR_QUANTITY</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span>alt_max<span class="token punctuation">)</span> \
    normalize_to_buffering_level <span class="token punctuation">(</span>queue<span class="token operator">-</span><span class="token operator">></span>cur_level<span class="token punctuation">.</span>format<span class="token punctuation">,</span>queue<span class="token operator">-</span><span class="token operator">></span>max_level<span class="token punctuation">.</span>format<span class="token punctuation">,</span><span class="token punctuation">(</span>alt_max<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/* figure out the buffering level we are filled, we take the max of all formats. */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>QUEUE_IS_USING_RING_BUFFER <span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  buflevel <span class="token operator">=</span> GET_BUFFER_LEVEL_FOR_QUANTITY <span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  guint64 rb_size <span class="token operator">=</span> queue<span class="token operator">-</span><span class="token operator">></span>ring_buffer_max_size<span class="token punctuation">;</span>
  buflevel <span class="token operator">=</span> GET_BUFFER_LEVEL_FOR_QUANTITY <span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> rb_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

buflevel2 <span class="token operator">=</span> GET_BUFFER_LEVEL_FOR_QUANTITY <span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buflevel <span class="token operator">=</span> MAX <span class="token punctuation">(</span>buflevel<span class="token punctuation">,</span> buflevel2<span class="token punctuation">)</span><span class="token punctuation">;</span>

buflevel2 <span class="token operator">=</span> GET_BUFFER_LEVEL_FOR_QUANTITY <span class="token punctuation">(</span>buffers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buflevel <span class="token operator">=</span> MAX <span class="token punctuation">(</span>buflevel<span class="token punctuation">,</span> buflevel2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* also apply the rate estimate when we need to */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token operator">-</span><span class="token operator">></span>use_rate_estimate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  buflevel2 <span class="token operator">=</span> GET_BUFFER_LEVEL_FOR_QUANTITY <span class="token punctuation">(</span>rate_time<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buflevel <span class="token operator">=</span> MAX <span class="token punctuation">(</span>buflevel<span class="token punctuation">,</span> buflevel2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>И она вычисляют уровень для байт, времени, буферов и rate_time, а потом берут из них максимальный.</p>
<h2>Написание плагина</h2>
<p>Лучшая статья по этой теме, что я видел: <a href="https://habr.com/ru/post/221483/">https://habr.com/ru/post/221483/</a></p>
<h2>Preroll</h2>
<p>Когда из состояния READY выставляем состояние PAUSED, то данные уже начинают идти по пайплайну, но когда они доходят до последнего sink-элемента (напр. alsasink), то они блочатся у его входа и в результате не "рендерятся". В этом состоянии каждый из элементов держит один или несколько буферов, но когда все элементы заполнят свои внутренние очереди, проход данных по пайплайну остановится до перехода в состояние PLAYING. Этот процесс называется pre-roll и он нужен для того, чтобы когда мы переведем в состояние PLAYING, переход прошел максимально быстро.</p>
<p>Все изменения состояния, идущие "наверх" (то есть NULL-READY-PAUSED-PLAYING) - выполняются асинхронно. То есть мы шлем команду на изменение состояния, она возвращается сразу же и потом от шины приходит сообщение, что состояние изменено.</p>
<p>Изменения состояния, идущие "вниз" - наоборот, все синхронны.</p>
<p>Главная разница между сигналами и сообщениями от шины - сигналы синхронны и могут вызваться из любого потока в любое время (поэтому в них нужно заботиться о мультипоточности). Сообщения - асинхронны и выполняются в потоке приложения, поэтому могут быть выполнены тогда, когда приложению будет удобно.</p>
<p>Свойство <code class="language-text">sync</code> у <code class="language-text">sink</code>-элементов означает, будет ли поток из этих элементов синхронизирован с часами. Если стоит <code class="language-text">false</code>, то поток будет выдан на рендер настолько быстро, насколько это возможно.</p>
<p><code class="language-text">gst-inspect-1.0 --gst-debug -help</code> - выводит всю инфу о том, что может быть залогировано</p>
<p>В GST dev tools есть GST debug viewer, который облегчит чтение логов.</p>
<p>Пример использования сетевых часов для мульти-рума: <a href="https://github.com/thaytan/gst-tutorial-lca2018/tree/master/network-clocks">https://github.com/thaytan/gst-tutorial-lca2018/tree/master/network-clocks</a></p>
<p>Working with dynamic pipelines: <a href="https://coaxion.net/blog/2014/01/gstreamer-dynamic-pipelines/">https://coaxion.net/blog/2014/01/gstreamer-dynamic-pipelines/</a> код из тэой статьи здесь: <a href="https://github.com/sdroege/gst-snippets/blob/217ae015aaddfe3f7aa66ffc936ce93401fca04e/dynamic-tee-vsink.c">https://github.com/sdroege/gst-snippets/blob/217ae015aaddfe3f7aa66ffc936ce93401fca04e/dynamic-tee-vsink.c</a></p>
<p>Когда регистрируем проб с типом <code class="language-text">GST_PAD_PROBE_TYPE_IDLE</code>, то указанный коллбэк будет вызван как только этот пад начнет простаивать, то есть по нему перестанут идти данные.</p>
<h2>Удаление ветви пайплайна</h2>
<p>Например, у нас есть такой пайплайн:

src -> bin -> conv -> tee -> queue -> fakesink			(1)
-> queue -> conv -> sink 		(2)</p>
<p>и мы хотим удалить ветвь (2)</p>
<p>Для этого мы берем наш src-pad элемента tee и ставим на него проб с типом <code class="language-text">GST_PAD_PROBE_TYPE_IDLE</code>. В коллбэке проба делаем следующее (<a href="https://github.com/sdroege/gst-snippets/blob/217ae015aaddfe3f7aa66ffc936ce93401fca04e/dynamic-tee-vsink.c#L93">https://github.com/sdroege/gst-snippets/blob/217ae015aaddfe3f7aa66ffc936ce93401fca04e/dynamic-tee-vsink.c#L93</a>):</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">teepad <span class="token operator">=</span> <span class="token function">gst_element_get_static_pad</span><span class="token punctuation">(</span>tee<span class="token punctuation">,</span> <span class="token string">"src_&lt;номер>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sinkpad <span class="token operator">=</span> gst_element_get_static_pad <span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token string">"sink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_pad_unlink <span class="token punctuation">(</span>teepad<span class="token punctuation">,</span> sinkpad<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_object_unref <span class="token punctuation">(</span>sinkpad<span class="token punctuation">)</span><span class="token punctuation">;</span>

gst_element_set_state <span class="token punctuation">(</span>sink<span class="token punctuation">,</span> GST_STATE_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_element_set_state <span class="token punctuation">(</span>conv<span class="token punctuation">,</span> GST_STATE_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_element_set_state <span class="token punctuation">(</span>queue<span class="token punctuation">,</span> GST_STATE_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

gst_bin_remove <span class="token punctuation">(</span>GST_BIN <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_bin_remove <span class="token punctuation">(</span>GST_BIN <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span> conv<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_bin_remove <span class="token punctuation">(</span>GST_BIN <span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">;</span>

gst_object_unref <span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_object_unref <span class="token punctuation">(</span>conv<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_object_unref <span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

gst_element_release_request_pad <span class="token punctuation">(</span>tee<span class="token punctuation">,</span> teepad<span class="token punctuation">)</span><span class="token punctuation">;</span>
gst_object_unref <span class="token punctuation">(</span>teepad<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> GST_PAD_PROBE_REMOVE<span class="token punctuation">;</span></code></pre></div>
<p>При окончании потока делаем gst<em>app</em>src<em>end</em>of_stream () чтобы послать EOS в пайплайн</p>
<p>В месте связи ветки ставим проб и ждем, пока придет EOS. только это надо сделать до того, как послали EOS.</p>
<p>Когда пришел EOS, запускаем наш unlink_cb</p>
<p>GST<em>PAD</em>PROBE<em>TYPE</em>EVENT_DOWNSTREAM чтобы ловить евенты через проб</p>
<p>нН чтобы были нотификации по ивентам, нужно сделать GST<em>PAD</em>PROBE<em>TYPE</em>EVENT_FLUSH</p>
<p>При получении EOS в пробе его можно дропнуть</p>
<h2>gst-shark</h2>
<p>Установка пути, куда сохраняются результаты:</p>
<p><code class="language-text">export GST_SHARK_LOCATION=~/profile</code></p>
<p>Запуск с трейсером:</p>
<p><code class="language-text">GST_TRACERS=&quot;tracer1;tracer2&quot; gst-launch-1.0 ...</code></p>
<p>Если нужно трейсерам указать параметры, то можно так:</p>
<p><code class="language-text">GST_TRACERS=&quot;tracer1(parameter1=value1);tracer2(parameter2=value2)&quot; gst-launch-1.0 ...</code></p>
<p>Параметром <code class="language-text">filter</code> можно устанавливать ограничение на профилируемый элемент. Значением фильтра пишем регэкспы по правилам Glib: <a href="https://developer.gnome.org/glib/stable/glib-regex-syntax.html">https://developer.gnome.org/glib/stable/glib-regex-syntax.html</a></p>
<p>Пример:</p>
<p><code class="language-text">gst-launch-1.0 videotestsrc ! identity name=i0 ! queue ! identity name=i1 ! x264enc ! identity name=i2 ! queue ! fakesink</code></p>
<p>Вывести фреймрейт в каждом из <code class="language-text">identity</code>:</p>
<p><code class="language-text">GST_TRACERS=&quot;framerate(filter=^i[0-9])&quot; GST_DEBUG=GST_TRACER:7</code></p>
<p>Вывести фреймрейт для всех <code class="language-text">identity</code> кроме <code class="language-text">i2</code></p>
<p><code class="language-text">GST_TRACERS=&quot;framerate(filter=^i[^2])&quot; GST_DEBUG=GST_TRACER:7</code></p>
<p>Вывести <code class="language-text">scheduletime</code> в <code class="language-text">videotestsrc</code>:</p>
<p><code class="language-text">GST_TRACERS=&quot;scheduletime(filter=videotestsrc0)&quot; GST_DEBUG=GST_TRACER:7</code></p>
<h2>Трейсеры</h2>
<ul>
<li><code class="language-text">interlatency</code> - Замеряет время, требуемое буферу, чтобы пройти от одной точки до другой внутри пайплайна. Предоставляет замеры времени, за которое буфер прошел от src первого элемента до src каждого последующего. Точность - нс.</li>
<li><code class="language-text">proctime</code> - замеры времени, за которое каждый из элементов обрабатывает очередной буфер</li>
<li><code class="language-text">framerate</code> - каждую секунду для каждого элемента выводит количество кадров, которое через него прошло</li>
<li><code class="language-text">scheduletime</code> - замеряет время, проходящее между появлениеями буферов на sink pad каждого элемента</li>
<li><code class="language-text">cpuusage</code> - каждую секунду выводит загрузку ЦП. <strong>ВАЖНО</strong>: это относится к общей загрузке ЦП, а не только той, которая обеспечивается пайплайном</li>
<li><code class="language-text">bitrate</code> - каждую секунду выводит битрейт</li>
<li><code class="language-text">queuelevel</code> - выводит, сколько байт и сколько буферов лежит в каждой очереди, обновляется каждый раз, когда в очередь входит новый буфер. НЕ РАБОТАЕТ с queue2, только с queue.</li>
<li><code class="language-text">buffer</code> - выводит инфу о каждом буфере, который выходит из первого (source) элемента. PTS = presentation time stamp (указывает, когда нужно отрендерить этот буфер), DTS = decoding time stamp (указывает, когда нужно декодировать этот кадр). Порядок рендера и декодирования может быть разный, потому что некоторые кадры может быть нужно декодировать раньше, чем они будут показаны.</li>
</ul></div></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-760779f5366ac4d94583.js","122212659448958":"component---src-templates-blog-template-js-40956da8f886eafeb36f.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","213534597649335":"component---src-pages-index-jsx-ed5f83543216989c42c9.js","218538773642512":"component---src-pages-page-2-js-65f0147ecb0dc4da2a2b.js","60335399758886":"path----312dbf55939ed237922c.js","229226591425695":"path---blog-video-microservices-what-we-learned-0884ad4603e69e1dcac2.js","100364315975247":"path---blog-video-dapp-introduction-b548e90718755ab19522.js","55495657889055":"path---blog-video-after-ddos-defense-0241be743ee49cbcf1c0.js","139359830059626":"path---blog-video-microservices-introduction-f3e72db12b0fbbb3d580.js","192092705425134":"path---blog-react-code-review-697d9acae8840b307adf.js","92226880614288":"path---howto-mips-gcc-a505e830d55ddf565e89.js","186363950922344":"path---blog-video-kafka-under-highload-7498bfc9a5f83fd88fbf.js","226923551111508":"path---blog-video-http-balancing-04a5d6bc3748744e2ccb.js","160831456888542":"path---blog-books-xv-6-77976c50122a2b12ef53.js","184279855636086":"path---blog-x-64-027becd65117534a097c.js","53213360603775":"path---blog-wget-3d0a2fa8d5d5aadf4073.js","27547127271145":"path---blog-virtualenv-5c46b5003c80cb6daffc.js","24818581494570":"path---blog-hardware-virtual-memory-fad50d4c43f973017653.js","98763693551004":"path---blog-hardware-video-a882f7233cbbe8420a8f.js","130591662829648":"path---blog-hardware-usb-2902438d72114310e6d2.js","9365413787972":"path---blog-tmux-18af5c3ee5786bc23e5e.js","162551281273053":"path---blog-systemd-3c5d81a37ef2bf9633a3.js","186644301018450":"path---blog-sh-f755e53a5a03b841d356.js","73744929748382":"path---blog-sed-524bf25b9638fccdbe6a.js","104991713993326":"path---blog-pip-0c3afd51fac4a25801c0.js","264201604445726":"path---blog-pdb-76c1660f2df57c525180.js","133853690878566":"path---blog-npm-bb10bfcf6f9c0e0bf4dc.js","109648760230997":"path---blog-video-microservices-patterns-playbook-789b40dcdf4d315ca285.js","159123021256651":"path---blog-kazoo-c5baddaecdbd8e79e06f.js","104310528048563":"path---blog-gcc-60cab66f382244efa6e5.js","150932571510165":"path---blog-find-106c4a6da01e48c52c97.js","110067976222435":"path---blog-hardware-disk-219303244426b14efd34.js","132138994540798":"path---blog-hardware-cpu-4cd2e518ccf742e8026f.js","55889076892030":"path---blog-books-computer-organization-and-design-551b64c038cd8a8a7db3.js","77570552653218":"path---blog-books-build-systems-61c7d7daaeea78630813.js","131670063006948":"path---blog-webpack-eea4c423ab2c581a7173.js","48555064563601":"path---blog-webpack-2-6ce1d63fcafb568abf3c.js","36163852562177":"path---blog-web-components-8bed9122b7db08e720e7.js","274395942926096":"path---blog-vim-306d161ecf3d14f805cd.js","207874380873722":"path---blog-typescript-60246b269a52e1ceeb2b.js","1112656806016":"path---blog-storybook-2791d3ca1e40cfc49940.js","65468590155737":"path---blog-books-stackframes-b8b40710ce69894b0c5a.js","85756719843508":"path---blog-spring-boot-0449fae4827a3a8079dc.js","94230034957513":"path---blog-mvc-sessionless-state-12281ec2091582c9e1ae.js","34503133861313":"path---blog-swig-e65ae73a99dd8664b742.js","9783932336651":"path---blog-ssl-ac8e7af60f8e442f001f.js","30778352477470":"path---blog-sql-recursive-cte-e309358783bcfe2098be.js","218031196284409":"path---blog-sql-fizzbuzz-76358ca446199abcc715.js","123969815895874":"path---blog-ruby-14fdae3024d52c4eec60.js","254035159982288":"path---blog-riak-23ed851bd2d7245a8d3a.js","204811817341229":"path---blog-redux-e7409d89c1574466a4e4.js","92818489627367":"path---blog-redux-2-6f2fe56d9b8eadc3bdcb.js","62231134199178":"path---blog-react-325a394f30627b1112cd.js","148854442917752":"path---blog-rabbitmq-53a39cc32af408eb651c.js","38855089869933":"path---blog-hardware-ram-5a3202a5e17f7bf17eb9.js","148886276492926":"path---blog-python-2-16aba90ef642ebadf689.js","105666842049118":"path---blog-python-b15e3998e19f05894e7d.js","269087443385385":"path---blog-postcss-1e8634868bcf12e36017.js","256307876683203":"path---blog-oauth-b2ee92c5f2c99aa16bac.js","143217941000248":"path---blog-nodejs-4fbe4ecce764a2f99586.js","28480827339995":"path---blog-nginx-d1b296a6d40b27eec596.js","244296159480370":"path---blog-mongodb-67d8fb27ae9d35cedec3.js","250734049749304":"path---blog-maven-37bfd707207a90b5fa91.js","189813236319561":"path---blog-linux-networking-c9e3f2c395c2ab7524bc.js","64880211853811":"path---blog-linux-debugging-f1c50eefb0f497f26571.js","79569183618093":"path---blog-linux-api-30868a1fc86617d91ac5.js","197411268609348":"path---blog-knockout-9d7309f5a90674955f0e.js","229750489612856":"path---blog-kafka-c729d024b265bd63649c.js","123278874046992":"path---blog-javascript-b32a8b5f65b78b7a63cc.js","53396112491056":"path---blog-java-c1052aeaac33bb5e3a0c.js","18938219703366":"path---blog-js-event-loop-f72490c1078996bba861.js","142042848561750":"path---blog-how-would-you-implement-1fc9253bee637ec5ea87.js","154704496480088":"path---blog-books-how-linux-works-95b7a473303526894b85.js","76495366757855":"path---blog-gstreamer-17e17ee2f5b769d89761.js","190181808776960":"path---blog-google-test-83b826a7e7901cc8fbfb.js","130613441630911":"path---blog-gitlab-ci-2bd6e341f1d29fa93fee.js","60149745945718":"path---blog-git-015c63e61f9bb5306562.js","68448465120492":"path---blog-gdb-edd9b2ffeadf11d89b94.js","191388377664321":"path---blog-flexbox-febdf9ef23ed0060a9fd.js","259445767305737":"path---blog-express-ec7a288889ccaeb70088.js","104734089325636":"path---blog-books-effective-modern-cpp-d5262103b218ee591c7d.js","267150169503670":"path---blog-docker-compose-3910951dddf38c7a76f4.js","97711108842923":"path---blog-docker-0631f164426a92770b94.js","100237555697753":"path---blog-books-voice-user-interfaces-1e8899030550fccf1732.js","838797986268":"path---blog-books-designing-data-intensive-applications-1c92402b0c9668547088.js","175567745484808":"path---blog-debian-bootstrap-d2cb7ffc79ddd7123412.js","246498121182663":"path---blog-debian-8c0de52efafae3b00dd1.js","109290739445578":"path---blog-call-conventions-2e16a9a1d1ec666883a4.js","249667644861725":"path---blog-css-6860c1a2a8a9f8c71bcf.js","257759292890660":"path---blog-web-security-de5391424f8c2eff59c4.js","226785351346532":"path---blog-cmake-3b43990862b85e4c37ad.js","143229806240817":"path---blog-cpp-5dbf5accd220298d64cf.js","159223318109625":"path---blog-backstopjs-440f435b6f9dfe842bf7.js","69801897094251":"path---blog-architecture-2f5dae4941f3222c6147.js","117626492464451":"path---blog-algorithms-d93de066b8df0a88705f.js","215540810942742":"path---blog-mvc-async-controllers-c3cc24f140a51a9e6bb0.js","27779406687296":"path---blog-mvc-web-farms-9cb51abf17a7815a45a8.js","146292636605172":"path---blog-mvc-web-sockets-f514dc5c70b846e58e06.js","279780729786774":"path---blog-mvc-modules-handlers-44f1e163873a16c2c733.js","77216212851623":"path---blog-mvc-data-tampering-118028cf133af5b92d65.js","13218921337688":"path---blog-video-10-ways-to-get-highload-and-bigdata-94abfce78af88d7ab06d.js","225240287407359":"path---blog-dotnet-f3909ed15ac55af9cb3d.js","44704367536930":"path---blog-dotnet-monitor-1f18de743523b22605b1.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-cd75096db2886a7c8b39.js","135728916539164":"path---page-2-a0e39f21c11f6a62c5ab.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-1480ae19d67cb2342bca.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/hows-that-again/commons-afb5782224ac01f1fa03.js","/hows-that-again/app-760779f5366ac4d94583.js","/hows-that-again/path---blog-gstreamer-17e17ee2f5b769d89761.js","/hows-that-again/component---src-templates-blog-template-js-40956da8f886eafeb36f.js","/hows-that-again/component---src-layouts-index-js-1480ae19d67cb2342bca.js"])/*]]>*/</script></body></html>