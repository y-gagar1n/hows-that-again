<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/hows-that-again/component---src-layouts-index-js-98bb4023ce251944db56.js" as="script"/><link rel="preload" href="/hows-that-again/component---src-templates-blog-template-js-40956da8f886eafeb36f.js" as="script"/><link rel="preload" href="/hows-that-again/path---blog-call-conventions-2e16a9a1d1ec666883a4.js" as="script"/><link rel="preload" href="/hows-that-again/app-465af5bf3d08c16ddee0.js" as="script"/><link rel="preload" href="/hows-that-again/commons-afb5782224ac01f1fa03.js" as="script"/><title data-react-helmet="true">How&#x27;s that again?</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><style id="gatsby-inlined-css">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt","kern"}img{max-width:100%;margin:0 0 1.45rem;padding:0}h1{font-size:2.25rem}h1,h2{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{margin:0 0 1.45rem 1.45rem;padding:0;list-style-position:outside;list-style-image:none}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{padding:0;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}pre,table{margin:0 0 1.45rem}table{padding:0;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{margin:0 0 calc(1.45rem - 1px);padding:0;background:rgba(0,0,0,.2);border:none;height:1px}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:0;padding-top:.2em;padding-bottom:.2em}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="515610584"><!-- react-empty: 2 --><div style="background:rebeccapurple;margin-bottom:1.45rem;" data-reactid="3"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;" data-reactid="4"><h1 style="margin:0;" data-reactid="5"><a style="color:white;text-decoration:none;" href="/hows-that-again/" data-reactid="6">How&#x27;s that again?</a></h1></div></div><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0;" data-reactid="7"><div class="blog-post-container" data-reactid="8"><div class="blog-post" data-reactid="9"><div class="blog-post-content" data-reactid="10"><h1>Соглашения вызова</h1>
<p><a href="https://en.wikibooks.org/wiki/X86_Disassembly/Functions_and_Stack_Frames">Вики</a></p>
<p><a href="https://www.codeproject.com/Articles/1388/Calling-Conventions-Demystified">CodeProject</a></p>
<p>(<a href="https://stackoverflow.com/questions/1395591/what-is-exactly-the-base-pointer-and-stack-pointer-to-what-do-they-point">https://stackoverflow.com/questions/1395591/what-is-exactly-the-base-pointer-and-stack-pointer-to-what-do-they-point</a>)</p>
<blockquote>
<p>TL;DR: Для x86 в винде используется <strong>Microsoft x64 calling convention</strong>, в линуксе <strong>System V ABI</strong>.</p>
</blockquote>
<p>В x86 - 8 32-битных регистров.</p>
<p>В x64 - 16 64-битных регистров. 64-битные версии <strong>Е*</strong> регистров называются <strong>R*</strong>. Дополнительные регистры получили названия <code class="language-text">r8...r15</code>.</p>
<ul>
<li><strong>ESP</strong> - <em>stack pointer</em>, вершина стека. Указывает на текущую вершину стэка. Операции <code class="language-text">push</code> и <code class="language-text">pop</code> читают из <strong>ESP</strong> адрес, по которому обращаться к стэку, а в конце раобты меняют значение <strong>ESP</strong>. После пролога функции все локальные переменные и аргументы оказываются выше <strong>ESP</strong>.</li>
<li><strong>EBP</strong> - <em>frame pointer</em>, вершина фрейма. Все аргументы функции и адрес возврата находятся выше его, а локальные переменные - ниже.</li>
</ul>
<h2>Синтаксис MOV</h2>
<p><code class="language-text">mov %eax, %edx</code></p>
<p>Есть два синтаксиса:</p>
<ul>
<li><strong>Intel</strong>: перемещает <strong>EDX</strong> в <strong>EAX</strong>. Используется во всяких MASM, TASM, NASM, FASM. </li>
<li><strong>AT&#x26;T</strong>: перемещает <strong>EAX</strong> в <strong>EDX</strong>. Используется во всех Unix-системах.</li>
</ul>
<p>Так как работаем в основном в линуксе, то в большинстве случаев будет встречаться вариант, когда <code class="language-text">mov %eax, %edx</code> означает присвовить регистру <strong>edx</strong> значение регистра <strong>edx</strong>.</p>
<h2>Как определить используемое соглашение</h2>
<p>Делаем <code class="language-text">nm</code> на интересующей библиотеке и смотрим на имена символов.</p>
<p>Если начинаются с <code class="language-text">_</code> и не содержат <code class="language-text">@</code>, то это <code class="language-text">__cdecl</code>.</p>
<p>Если начинаются с <code class="language-text">_</code> и содержат <code class="language-text">@</code>, то это <code class="language-text">__stdcall</code>.</p>
<p>Если начинается с <code class="language-text">@</code> и содержит еще одну <code class="language-text">@</code>, то это <code class="language-text">__fastcall</code>.</p>
<h2>Пролог</h2>
<p>Обычно функция начинается с автосгенерированного пролога:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">push ebp ; сохраняем вершину фрейма, чтобы после выхода из функции вызывающая функция смогла обращаться к своим локальным переменным
mov esp, ebp ; перемещаем вершину фрейма вниз, записывая в нее текущее значение вершины стека
sub esp, 20 ; локальные переменные функции находятся на стеке и ниже вершины фрейма, поэтому уменьшаем вершину стека на 20 байт, чтобы выделить 20 байт под локальные переменные</code></pre></div>
<p>После этого <strong>EBP</strong> будет указывать на начало текущего фрейма, а <strong>ESP</strong> - на его конец.</p>
<p>Затем в коде обращение к локальным переменным может выглядеть так:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">mov eax, [ebp-4] ; сохраняем eax в первую локальную переменную
mov ebx, [ebp-8] ; читаем вторую локальную переменную в регистр ebx</code></pre></div>
<h2>Эпилог</h2>
<p>А выход из функции (эпилог) выглядит так:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">mov ebp, esp;   ; грохаем все локальные переменные со стека
pop ebp;        ; восстанавливаем предыдущее значение ebp, чтобы оно указывало на вершину фрейма вызывающей функции
ret             ; возвращаемся в вызывающую функцию</code></pre></div>
<p>Для перечисленных ниже соглашений (кроме <code class="language-text">[cdecl]</code>) перед возвратом значений из функции подпрограмма обязана восстановить значения сегментных регистров, регистров <code class="language-text">esp</code> и <code class="language-text">ebp</code>. Значения остальных регистров могут не восстанавливаться.</p>
<p>Если размер возвращаемого значения функции не больше размера регистра <code class="language-text">eax</code>, возвращаемое значение сохраняется в регистре <code class="language-text">eax</code>. Иначе, возвращаемое значение сохраняется на вершине стека, а указатель на вершину стека сохраняется в регистре <code class="language-text">eax</code>.</p>
<h2>Соглашения</h2>
<p>Пусть у нас есть такая функция:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sumExample</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Которая вызывается вот так:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">sumExample</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3>System V ABI</h3>
<p><a href="https://wiki.osdev.org/System_V_ABI">https://wiki.osdev.org/System<em>V</em>ABI</a></p>
<p>Функции вызываются командами <code class="language-text">call</code> и <code class="language-text">callq</code>, которые пушат на стек адрес следующей инструкции и вызывают джамп. Возврат осуществляется командой <code class="language-text">ret</code>, которая попает со стека адрес возврата и джампает на него. Перед вызовом <code class="language-text">call</code> стэк выравнивается по 16 байтам.</p>
<p>Аргументы, переданные через стек, могут быть модифированы вызываемой функцией.</p>
<h4>x86</h4>
<p>Аргументы передаются через стек. </p>
<p>Функции сохраняют значения регистров <code class="language-text">ebx, esi, edi, ebp, esp</code>, а регистры <code class="language-text">eax, ecx, edx</code> могут быть затерты. Значение возвращается через регистр <code class="language-text">eax</code>, а если он больше 32 бит, то верхние 32 бита идут в <code class="language-text">edx</code>.</p>
<h4>x64</h4>
<p>Аргументы передаются в регистрах <code class="language-text">rdi, rsi, rdx, rcx, r8, r9</code>, остальные - на стеке, справа налево. </p>
<p>Функции сохраняют значения регистров <code class="language-text">rbx, rsp, rbp, r12, r13, r14, r15</code>, а регистры <code class="language-text">rax, rdi, rsi, rdx, rcx, r8, r9, r10, r11</code> могут быть затерты. Значение возвращается через регистр <code class="language-text">rax</code>, а если он больше 64 бит, то верхние 64 бита идут в <code class="language-text">rdx</code>.</p>
<p>Пример:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">sum.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &lt;sumExample&gt;:
   0:   55                      push   %rbp               ; бэкапим вершину стека родителя
   1:   48 89 e5                mov    %rsp,%rbp          ; заводим себе фрейм
   4:   89 7d fc                mov    %edi,-0x4(%rbp)    ; кладем в локальную переменную первый аргумент  
   7:   89 75 f8                mov    %esi,-0x8(%rbp)    ; кладем в локальную переменную второй аргумент
   a:   8b 55 fc                mov    -0x4(%rbp),%edx    ; из локальной переменной перемещаем первый аргумент в регистр edx
   d:   8b 45 f8                mov    -0x8(%rbp),%eax    ; из локальной переменной перемещаем второй аргумент в регистр eax
  10:   01 d0                   add    %edx,%eax          ; складываем регистры, результат окажется в eax
  12:   5d                      pop    %rbp               ; ресторим вершину стека родителя
  13:   c3                      retq                      ; возвращаемся

0000000000000014 &lt;main&gt;:
  14:   55                      push   %rbp               ; бэкапим вершину стека родителя
  15:   48 89 e5                mov    %rsp,%rbp          ; заводим себе фрейм
  18:   48 83 ec 10             sub    $0x10,%rsp         ; заводим место на стеке для 2 переменных (хз зачем, вроде оно тут не используется)
  1c:   be 03 00 00 00          mov    $0x3,%esi          ; пишем 3 в регистр первого аргумента 
  21:   bf 02 00 00 00          mov    $0x2,%edi          ; пишем 2 в регистр второго аргумента
  26:   e8 00 00 00 00          callq  2b &lt;main+0x17&gt;     ; вызываем sumExample
  2b:   89 45 fc                mov    %eax,-0x4(%rbp)    ; кладем результат в локальную переменную
  2e:   90                      nop
  2f:   c9                      leaveq
  30:   c3                      retq</code></pre></div>
<h3>cdecl</h3>
<p><code class="language-text">cdecl</code> — соглашение о вызовах, используемое компиляторами для языка <strong>C</strong>.</p>
<p>Аргументы функций передаются через стек, справа налево. Аргументы, размер которых меньше 4-х байт, расширяются до 4-х байт. Очистку стека производит <strong>вызывающая</strong> программа. Это основной способ вызова функций с переменным числом аргументов (например, <code class="language-text">[printf()](https://ru.wikipedia.org/wiki/Printf)</code>). Названия функций имеют префикс '_'. Способы получения возвращаемого значения функции приведены в таблице.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/hows-that-again/static/b9425fe9a118d6287eb920b2d7ba0a4d/a8a2c/calling-convention-return.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 650px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 12.153846153846155%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsSAAALEgHS3X78AAAAdklEQVQI1z2JSw6DIAAFvf8NmzYaFBEof0Ttavwsuphk3rzOh8ikvliXkfOCGCWTVEyzZpSG13vg04un37/SFmPdw936QaAv18bhQ6LT1jNrj3EFHzPbftAu9uNHiBEhLXLxqEUTUiXmlVQqKVdKbZS1/ffaNk4KrJX4x41vmgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Таблица 1"
        title=""
        src="/hows-that-again/static/b9425fe9a118d6287eb920b2d7ba0a4d/10273/calling-convention-return.png"
        srcset="/hows-that-again/static/b9425fe9a118d6287eb920b2d7ba0a4d/9b14a/calling-convention-return.png 163w,
/hows-that-again/static/b9425fe9a118d6287eb920b2d7ba0a4d/94962/calling-convention-return.png 325w,
/hows-that-again/static/b9425fe9a118d6287eb920b2d7ba0a4d/10273/calling-convention-return.png 650w,
/hows-that-again/static/b9425fe9a118d6287eb920b2d7ba0a4d/2fc6f/calling-convention-return.png 975w,
/hows-that-again/static/b9425fe9a118d6287eb920b2d7ba0a4d/a8a2c/calling-convention-return.png 1300w"
        sizes="(max-width: 650px) 100vw, 650px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Перед вызовом функции вставляется код, называемый <strong>прологом</strong> и выполняющий следующие действия:</p>
<ul>
<li>сохранение значений регистров, используемых внутри функции;</li>
<li>запись в стек аргументов функции</li>
</ul>
<p>После вызова функции вставляется код, называемый <strong>эпилогом</strong> и выполняющий следующие действия:</p>
<ul>
<li>восстановление значений регистров, сохранённых кодом пролога;</li>
<li>очистка стека (от локальных переменных и аргументов).</li>
</ul>
<p>Пример:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">    ; sumExample(2, 3)

    ; записываем в стек аргументы функции справа налево
    push 3
    push 2

    ; вызываем функцию
    call _sumExample

    ; очищаем стек от аргументов
    add esp,8

    ; копишуем возвращаемое значение (eax) в локальную переменную c
    mov dword ptr [c],eax</code></pre></div>
<p>Вызываемая функция выглядит так:</p>
<div class="gatsby-highlight" data-language="asm"><pre class="language-asm"><code class="language-asm">; пролог

push ebp
mov ebp,esp   ; после этого над EBP находятся аргументы 2 и 3, а под ним будут локальные переменные
sub esp,0C0h  ; выделяем на стеке место для 12 байт под локальные переменные
push ebx
push esi
push edi
lea edi,[ebp-0C0h]  ; lea = load effective address, получаем адрес в памяти для вершины стека
mov ecx,30h
mov eax,0CCCCCCCCh
rep stos dword ptr [edi]

; return a + b;
mov eax,dword ptr [a]
add eax,dword ptr [b]

; эпилог
pop edi
pop esi
pop ebx
mov esp,ebp
pop ebp

ret</code></pre></div>
<h3>stdcall или winapi</h3>
<p><code class="language-text">stdcall</code> или <code class="language-text">winapi</code> — соглашение о вызовах, применяемое в Windows для вызова функций WinAPI.</p>
<p>Аргументы функций передаются через стек, справа налево. Очистку стека производит вызываемая подпрограмма. Названия функций имеют префикс '_' и постфикс вида '@+необходимое количество байт на стэке'.</p>
<p>Пример:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">; // push arguments to the stack, from right to left
  push        3
  push        2

; // call the function
  call        _sumExample@8

; // copy the return value from EAX to a local variable (int c)  
  mov         dword ptr [c],eax</code></pre></div>
<p>Код функции:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">; // function prolog goes here (the same code as in the __cdecl example)

; //    return a + b;
  mov         eax,dword ptr [a]
  add         eax,dword ptr [b]

; // function epilog goes here (the same code as in the __cdecl example)

; // cleanup the stack and return
  ret         8</code></pre></div>
<p>Так как очистку стэка производит вызываемая программа, то размер бинарников получается меньше, чем у cdecl. Однако функциям с переменным числом аргументов приходится использовать cdecl, потому что только вызывающий код знает количество аргументов.</p>
<h3>fastcall</h3>
<p><code class="language-text">fastcall</code> — общее название соглашений, передающих параметры через регистры (обычно это самый быстрый способ, отсюда название). Если для сохранения всех параметров и промежуточных результатов регистров не достаточно, используется стек.</p>
<p>Соглашение о вызовах <code class="language-text">fastcall</code> не стандартизировано, поэтому используется только для вызова процедур и функций, не экспортируемых из исполняемого модуля и не импортируемых извне.
В компиляторах фирмы Borland для соглашения __fastcall, называемого также register[5], параметры передаются слева направо в регистрах eax, edx, ecx, а если параметров больше трёх — в стеке, также слева направо. Исходное значение указателя на вершину стека (значение регистра esp) возвращает вызываемая подпрограмма.</p>
<p>В 32-разрядной версии компилятора фирмы Microsoft, а также в компиляторе GCC, соглашение __fastcall, также называемое __msfastcall, определяет передачу первых двух параметров слева направо в регистрах ecx и edx, а остальные параметры передаются справа налево в стеке. Очистку стека производит вызываемая подпрограмма.</p>
<p>Названия функций начинаются с @ и заканчиваются на @ + необходимое количество байт на стэке.</p>
<p>Пример:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">; // put the arguments in the registers EDX and ECX
  mov         edx,3
  mov         ecx,2

; // call the function
  call        @fastcallSum@8

; // copy the return value from EAX to a local variable (int c)  
  mov         dword ptr [c],eax</code></pre></div>
<p>Код функции:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">; // function prolog

  push        ebp  
  mov         ebp,esp
  sub         esp,0D8h
  push        ebx  
  push        esi  
  push        edi  
  push        ecx  
  lea         edi,[ebp-0D8h]
  mov         ecx,36h
  mov         eax,0CCCCCCCCh
  rep stos    dword ptr [edi]
  pop         ecx  
  mov         dword ptr [ebp-14h],edx
  mov         dword ptr [ebp-8],ecx
; // return a + b;
  mov         eax,dword ptr [a]
  add         eax,dword ptr [b]
;// function epilog  
  pop         edi  
  pop         esi  
  pop         ebx  
  mov         esp,ebp
  pop         ebp  
  ret</code></pre></div>
<h3>thiscall</h3>
<p>thiscall — соглашение о вызовах, используемое компиляторами для языка C++ при вызове методов классов в объектно-ориентированном программировании.</p>
<p>Аргументы функции передаются через стек, справа налево. Очистку стека производит вызывающая программа. Соглашение thiscall отличается от cdecl соглашения только тем, что указатель на объект, для которого вызывается метод (указатель this), записывается в регистр ecx[8]. Если же используется функция с переменным количеством аргументов, то this кладется на стэк последним.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">push        3
push        2
lea         ecx,[sumObj]
call        ?sum@CSum@@QAEHHH@Z            ; CSum::sum
mov         dword ptr [s4],eax</code></pre></div>
<p>Код функции:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">    push        ebp
    mov         ebp,esp
    sub         esp,0CCh
    push        ebx
    push        esi
    push        edi
    push        ecx
    lea         edi,[ebp-0CCh]
    mov         ecx,33h
    mov         eax,0CCCCCCCCh
    rep stos    dword ptr [edi]
    pop         ecx
    mov         dword ptr [ebp-8],ecx
    mov         eax,dword ptr [a]
    add         eax,dword ptr [b]
    pop         edi
    pop         esi
    pop         ebx
    mov         esp,ebp
    pop         ebp
    ret         8</code></pre></div>
<p>To cut a long story short, we'll outline the main differences between the calling conventions:</p>
<ul>
<li><code class="language-text">__cdecl</code> is the default calling convention for C and C++ programs. The advantage of this calling convetion is that it allows functions with a variable number of arguments to be used. The disadvantage is that it creates larger executables.</li>
<li><code class="language-text">__stdcall</code> is used to call Win32 API functions. It does not allow functions to have a variable number of arguments.</li>
<li><code class="language-text">__fastcall</code> attempts to put arguments in registers, rather than on the stack, thus making function calls faster.</li>
<li><code class="language-text">Thiscall</code> calling convention is the default calling convention used by C++ member functions that do not use variable arguments.</li>
</ul>
<h2>X64</h2>
<p>В X64 все Е* регистры называются R*. <a href="https://msdn.microsoft.com/ru-ru/library/9z1stfyw.aspx">https://msdn.microsoft.com/ru-ru/library/9z1stfyw.aspx</a></p>
<p>В X64 используется только __fastcall, причем регистры используются для передачи первых 4 аргументов. Аргументы передаются в регистрах RCX, RDX, R8 и R9.</p></div></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-465af5bf3d08c16ddee0.js","122212659448958":"component---src-templates-blog-template-js-40956da8f886eafeb36f.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","213534597649335":"component---src-pages-index-jsx-ed5f83543216989c42c9.js","218538773642512":"component---src-pages-page-2-js-65f0147ecb0dc4da2a2b.js","60335399758886":"path----312dbf55939ed237922c.js","229226591425695":"path---blog-video-microservices-what-we-learned-0884ad4603e69e1dcac2.js","100364315975247":"path---blog-video-dapp-introduction-b548e90718755ab19522.js","55495657889055":"path---blog-video-after-ddos-defense-0241be743ee49cbcf1c0.js","139359830059626":"path---blog-video-microservices-introduction-f3e72db12b0fbbb3d580.js","192092705425134":"path---blog-react-code-review-697d9acae8840b307adf.js","92226880614288":"path---howto-mips-gcc-a505e830d55ddf565e89.js","186363950922344":"path---blog-video-kafka-under-highload-7498bfc9a5f83fd88fbf.js","226923551111508":"path---blog-video-http-balancing-04a5d6bc3748744e2ccb.js","160831456888542":"path---blog-books-xv-6-77976c50122a2b12ef53.js","184279855636086":"path---blog-x-64-027becd65117534a097c.js","53213360603775":"path---blog-wget-3d0a2fa8d5d5aadf4073.js","27547127271145":"path---blog-virtualenv-5c46b5003c80cb6daffc.js","24818581494570":"path---blog-hardware-virtual-memory-fad50d4c43f973017653.js","98763693551004":"path---blog-hardware-video-a882f7233cbbe8420a8f.js","130591662829648":"path---blog-hardware-usb-2902438d72114310e6d2.js","9365413787972":"path---blog-tmux-18af5c3ee5786bc23e5e.js","162551281273053":"path---blog-systemd-3c5d81a37ef2bf9633a3.js","186644301018450":"path---blog-sh-f755e53a5a03b841d356.js","73744929748382":"path---blog-sed-524bf25b9638fccdbe6a.js","104991713993326":"path---blog-pip-0c3afd51fac4a25801c0.js","264201604445726":"path---blog-pdb-76c1660f2df57c525180.js","133853690878566":"path---blog-npm-bb10bfcf6f9c0e0bf4dc.js","109648760230997":"path---blog-video-microservices-patterns-playbook-789b40dcdf4d315ca285.js","159123021256651":"path---blog-kazoo-c5baddaecdbd8e79e06f.js","104310528048563":"path---blog-gcc-60cab66f382244efa6e5.js","150932571510165":"path---blog-find-106c4a6da01e48c52c97.js","110067976222435":"path---blog-hardware-disk-219303244426b14efd34.js","132138994540798":"path---blog-hardware-cpu-4cd2e518ccf742e8026f.js","55889076892030":"path---blog-books-computer-organization-and-design-551b64c038cd8a8a7db3.js","77570552653218":"path---blog-books-build-systems-61c7d7daaeea78630813.js","131670063006948":"path---blog-webpack-eea4c423ab2c581a7173.js","48555064563601":"path---blog-webpack-2-6ce1d63fcafb568abf3c.js","36163852562177":"path---blog-web-components-8bed9122b7db08e720e7.js","274395942926096":"path---blog-vim-306d161ecf3d14f805cd.js","207874380873722":"path---blog-typescript-60246b269a52e1ceeb2b.js","1112656806016":"path---blog-storybook-2791d3ca1e40cfc49940.js","65468590155737":"path---blog-books-stackframes-b8b40710ce69894b0c5a.js","85756719843508":"path---blog-spring-boot-0449fae4827a3a8079dc.js","94230034957513":"path---blog-mvc-sessionless-state-12281ec2091582c9e1ae.js","34503133861313":"path---blog-swig-e65ae73a99dd8664b742.js","9783932336651":"path---blog-ssl-ac8e7af60f8e442f001f.js","30778352477470":"path---blog-sql-recursive-cte-e309358783bcfe2098be.js","218031196284409":"path---blog-sql-fizzbuzz-76358ca446199abcc715.js","123969815895874":"path---blog-ruby-14fdae3024d52c4eec60.js","254035159982288":"path---blog-riak-23ed851bd2d7245a8d3a.js","204811817341229":"path---blog-redux-e7409d89c1574466a4e4.js","92818489627367":"path---blog-redux-2-6f2fe56d9b8eadc3bdcb.js","62231134199178":"path---blog-react-325a394f30627b1112cd.js","148854442917752":"path---blog-rabbitmq-53a39cc32af408eb651c.js","38855089869933":"path---blog-hardware-ram-5a3202a5e17f7bf17eb9.js","148886276492926":"path---blog-python-2-16aba90ef642ebadf689.js","105666842049118":"path---blog-python-b15e3998e19f05894e7d.js","269087443385385":"path---blog-postcss-1e8634868bcf12e36017.js","256307876683203":"path---blog-oauth-b2ee92c5f2c99aa16bac.js","143217941000248":"path---blog-nodejs-4fbe4ecce764a2f99586.js","28480827339995":"path---blog-nginx-d1b296a6d40b27eec596.js","244296159480370":"path---blog-mongodb-67d8fb27ae9d35cedec3.js","250734049749304":"path---blog-maven-37bfd707207a90b5fa91.js","189813236319561":"path---blog-linux-networking-c9e3f2c395c2ab7524bc.js","64880211853811":"path---blog-linux-debugging-f1c50eefb0f497f26571.js","79569183618093":"path---blog-linux-api-30868a1fc86617d91ac5.js","197411268609348":"path---blog-knockout-9d7309f5a90674955f0e.js","229750489612856":"path---blog-kafka-c729d024b265bd63649c.js","123278874046992":"path---blog-javascript-b32a8b5f65b78b7a63cc.js","53396112491056":"path---blog-java-c1052aeaac33bb5e3a0c.js","18938219703366":"path---blog-js-event-loop-f72490c1078996bba861.js","142042848561750":"path---blog-how-would-you-implement-1fc9253bee637ec5ea87.js","154704496480088":"path---blog-books-how-linux-works-95b7a473303526894b85.js","76495366757855":"path---blog-gstreamer-17e17ee2f5b769d89761.js","190181808776960":"path---blog-google-test-83b826a7e7901cc8fbfb.js","130613441630911":"path---blog-gitlab-ci-2bd6e341f1d29fa93fee.js","60149745945718":"path---blog-git-015c63e61f9bb5306562.js","68448465120492":"path---blog-gdb-edd9b2ffeadf11d89b94.js","191388377664321":"path---blog-flexbox-febdf9ef23ed0060a9fd.js","259445767305737":"path---blog-express-ec7a288889ccaeb70088.js","104734089325636":"path---blog-books-effective-modern-cpp-c3f580eb492dd14ceab4.js","267150169503670":"path---blog-docker-compose-3910951dddf38c7a76f4.js","97711108842923":"path---blog-docker-0631f164426a92770b94.js","100237555697753":"path---blog-books-voice-user-interfaces-1e8899030550fccf1732.js","838797986268":"path---blog-books-designing-data-intensive-applications-1c92402b0c9668547088.js","175567745484808":"path---blog-debian-bootstrap-d2cb7ffc79ddd7123412.js","246498121182663":"path---blog-debian-8c0de52efafae3b00dd1.js","109290739445578":"path---blog-call-conventions-2e16a9a1d1ec666883a4.js","249667644861725":"path---blog-css-6860c1a2a8a9f8c71bcf.js","257759292890660":"path---blog-web-security-de5391424f8c2eff59c4.js","226785351346532":"path---blog-cmake-3b43990862b85e4c37ad.js","143229806240817":"path---blog-cpp-5dbf5accd220298d64cf.js","159223318109625":"path---blog-backstopjs-440f435b6f9dfe842bf7.js","69801897094251":"path---blog-architecture-2f5dae4941f3222c6147.js","117626492464451":"path---blog-algorithms-d93de066b8df0a88705f.js","215540810942742":"path---blog-mvc-async-controllers-c3cc24f140a51a9e6bb0.js","27779406687296":"path---blog-mvc-web-farms-9cb51abf17a7815a45a8.js","146292636605172":"path---blog-mvc-web-sockets-f514dc5c70b846e58e06.js","279780729786774":"path---blog-mvc-modules-handlers-44f1e163873a16c2c733.js","77216212851623":"path---blog-mvc-data-tampering-118028cf133af5b92d65.js","13218921337688":"path---blog-video-10-ways-to-get-highload-and-bigdata-94abfce78af88d7ab06d.js","225240287407359":"path---blog-dotnet-f3909ed15ac55af9cb3d.js","44704367536930":"path---blog-dotnet-monitor-1f18de743523b22605b1.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-397fb7942bf4a3f0218e.js","135728916539164":"path---page-2-a0e39f21c11f6a62c5ab.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-98bb4023ce251944db56.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/hows-that-again/commons-afb5782224ac01f1fa03.js","/hows-that-again/app-465af5bf3d08c16ddee0.js","/hows-that-again/path---blog-call-conventions-2e16a9a1d1ec666883a4.js","/hows-that-again/component---src-templates-blog-template-js-40956da8f886eafeb36f.js","/hows-that-again/component---src-layouts-index-js-98bb4023ce251944db56.js"])/*]]>*/</script></body></html>